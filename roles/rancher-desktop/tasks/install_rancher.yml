---
- name: Ensure Rancher Desktop is running (Linux)
  ansible.builtin.command: rdctl start
  register: rd_start
  changed_when: false
  failed_when: false
  when: ansible_system == 'Linux'

- name: Ensure Rancher Desktop is running (macOS)
  ansible.builtin.command:
    argv:
      - "/Applications/Rancher Desktop.app/Contents/Resources/resources/darwin/bin/rdctl"
      - "start"
      - "--kubernetes.enabled=true"
  changed_when: false
  when: ansible_facts['os_family'] == 'Darwin'

- name: Switch Kubernetes context to rancher-desktop
  ansible.builtin.command: kubectl config use-context rancher-desktop
  changed_when: false
  ignore_errors: true

# We need to wait for the cluster to be ready.
- name: Wait for Kubernetes API to be available
  ansible.builtin.command: kubectl cluster-info
  register: k8s_check
  until: k8s_check.rc == 0
  retries: 30
  delay: 10
  changed_when: false

- name: Add Jetstack Helm repository
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: https://charts.jetstack.io

- name: Add Rancher Latest Helm repository
  kubernetes.core.helm_repository:
    name: rancher-latest
    repo_url: https://releases.rancher.com/server-charts/latest

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  changed_when: false

- name: Create cert-manager namespace
  kubernetes.core.k8s:
    name: cert-manager
    api_version: v1
    kind: Namespace
    state: present

- name: Install cert-manager
  kubernetes.core.helm:
    name: cert-manager
    chart_ref: jetstack/cert-manager
    release_namespace: cert-manager
    create_namespace: false
    values:
      installCRDs: true
      securityContext:
        runAsNonRoot: false
      webhook:
        securityContext:
          runAsNonRoot: false
      cainjector:
        securityContext:
          runAsNonRoot: false
      startupapicheck:
        securityContext:
          runAsNonRoot: false
  register: cert_manager_install

- name: Wait for cert-manager to be ready
  ansible.builtin.command: kubectl rollout status deployment -n cert-manager cert-manager
  changed_when: false

- name: Create cattle-system namespace
  kubernetes.core.k8s:
    name: cattle-system
    api_version: v1
    kind: Namespace
    state: present

- name: Install Rancher Server
  kubernetes.core.helm:
    name: rancher
    chart_ref: rancher-latest/rancher
    release_namespace: cattle-system
    create_namespace: false
    values:
      hostname: rancher.localhost
      bootstrapPassword: admin
      replicas: 1
  register: rancher_install

- name: Wait for Rancher deployment to be ready
  ansible.builtin.command: kubectl rollout status deployment -n cattle-system rancher
  changed_when: false
